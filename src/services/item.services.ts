import itemModel from "../models/item.model";

import { Item, SelectItem } from "../interfaces/item.interfaces";

import {
	createObjIdService,
	createService,
	deleteObjService,
	findManyService,
	findOneService,
	queryExistService,
	queryItemsOfModelInPageService,
	updateObjService,
	updateOneService,
	countByQueryService,
} from "./model.services";
import {
	getDataFromURL,
	getSortObj,
	multiProcessService,
	paginateArrayService,
	removeUndefinedOfObj,
} from "./other.services";

import interactionModel from "../models/interaction.model";
import { async } from "@firebase/util";
import { getHistoryByUserService } from "./history.services";
import axios from "axios";
import { History } from "../interfaces/history.interfaces";

const getOneItemService = async (objQuery: any, properties: string = ""): Promise<Item | null> => {
	objQuery = removeUndefinedOfObj(objQuery);
	const item: Item | null = await itemModel
		.findOne(objQuery, properties)
		.lean()
		.populate({ path: "collectionInfo" })
		.populate({ path: "ownerInfo", select: "userAddress avatar username" })
		.populate({ path: "creatorInfo", select: "userAddress avatar username" });
	if (!item) return null;
	item.countFav = await countByQueryService(interactionModel, { itemId: item._id, state: true });
	return item;
};
export const checkItemExistsService = async (queryObj: object): Promise<boolean> => {
	return await queryExistService(itemModel, queryObj);
};

const getAllItemService = async (objQuery: any, properties: string = ""): Promise<Item[]> => {
	objQuery = removeUndefinedOfObj(objQuery);
	let itemList: Item[] = await itemModel
		.find(objQuery, properties)
		.lean()
		.populate({ path: "collectionInfo" })
		.populate({ path: "ownerInfo", select: "userAddress avatar username" })
		.populate({ path: "creatorInfo", select: "userAddress avatar username" });
	itemList = await Promise.all(
		itemList.map(async (item: any) => {
			let newItem = item;
			newItem.countFav = await countByQueryService(interactionModel, { itemId: item._id, state: true });
			return newItem;
		}),
	);
	itemList = itemList.sort((a: any, b: any) => b.countFav - a.countFav);
	return itemList;
};

export const checkChainIdItemService = async(id: String, chainId: Number) => {
	const items: Item = await findOneService(itemModel, {_id: id})
	if(Number(items.chainId) === chainId){ 
		return true
	} else return false;
};

export const getListSelectItemService = async(listItem: []) => {
	let item: Item[]= [];
	await Promise.all(
		listItem.map(async (items: String) => {
			console.log(items)
			const getItem: Item = await findOneService(itemModel,{_id: items});
			if(!getItem){
				console.log('Item not found');
			} else
			item.push(getItem);
		})
	);
	return item;
};

const randomListItem = async(arr: Item[], n: number) => {
	let result: Item[] = [];
	let randomIndex;
	let length = arr.length;
	for(let i = 0; i < n; i++ ){
		randomIndex = Math.floor(Math.random() * length);
		result.push(arr.splice(randomIndex, 1)[0]);
		length--;
	}
	return result;
}

export const getListRandomItemService = async() => {
	const allItem = await findManyService(itemModel, {});
	const result: Item[] = await randomListItem(allItem, 10);
	return result;
};

export const getListItemByCreatedService = async(userAddress: String) => {
	const item: Item[] = await findManyService(itemModel, {created: userAddress});
	return item;
};

export const getListItemByOwnerService = async(userAddress: String) => {
	const itemAll: Item[] = await findManyService(itemModel, {});
	const item: Item[] = [];
	Promise.all(
		itemAll.map(async (items: Item) => {
			if(items.creator !== userAddress){
				const owner: String[] = items.owner;
				owner.map(async (owners: String) => {
					if(owners === userAddress){
						item.push(items);
						return;
					}
				}) 
			}
		})
	);
	return item;
};

const getTransactions = async (address: any) => {
	const response = await axios.get(`https://fullnode.testnet.aptoslabs.com/v1/accounts/${address}/transactions`);
	const result: String[] = [];
	const data: [] = response.data;
	await Promise.all(
		data.map(async (dataM: any) => {
			const history: History[] = await getHistoryByUserService(address, {});
			const hash: String[] = history.map((hash: History) => hash.txHash);
			// console.log(hash);
			await Promise.all(
				hash.map(async (txhash: String) => {
					if(String(dataM.hash) !== String(txhash)){
						result.push(String(dataM.hash));
						console.log(String(dataM.hash));
					}
				})
			)
		})
	);
	const transactions = result;
	return transactions;
  }

export const getTransactionService = async () => {
	const address = '0xf72cd5aa323a3e36ba73807f588885e047a5d1446dbccde3d4a4e8d6f6d8259f';
	const transactions = await getTransactions(address);
	// console.log(transactions);
	return transactions;
}

export { getOneItemService, getAllItemService }; 